<!DOCTYPE html>
<html lang="nl" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Barcode Scanner ‚Äî Pro (iPhone Focus ‚Ä¢ Beep ‚Ä¢ Notifies ‚Ä¢ Export)</title>
<meta name="robots" content="noindex,nofollow" />
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
<style>
  /* =========================
     THEME & LAYOUT
     ========================= */
  :root{
    --bg:#f5f6f8; --panel:#ffffff; --ink:#1f2328; --muted:#6c757d;
    --brand:#0d6efd; --brand-2:#4f46e5; --brand-dark:#0a58ca;
    --ok:#16a34a; --ok-2:#22c55e; --danger:#dc2626; --warn:#f59e0b;
    --border:#d0d7de; --soft:#eef2f7; --chip:#eef2ff; --chip-ink:#3146b5;
    --card-shadow:0 10px 30px rgba(0,0,0,.09);
  }
  [data-theme="dark"]{
    --bg:#0b1220; --panel:#0f172a; --ink:#e8eefc; --muted:#96a0b5;
    --brand:#3b82f6; --brand-2:#6366f1; --brand-dark:#2563eb;
    --ok:#22c55e; --ok-2:#4ade80; --danger:#ef4444; --warn:#f59e0b;
    --border:#25314a; --soft:#121a2d; --chip:#132040; --chip-ink:#7aa2ff;
    --card-shadow:0 12px 36px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font:16px/1.5 system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Inter,Roboto,Arial,sans-serif;
  }
  header{
    display:flex; align-items:center; justify-content:space-between; gap:16px;
    padding:16px 24px; background:linear-gradient(90deg,var(--brand),var(--brand-2));
    color:#fff; box-shadow:var(--card-shadow); position:sticky; top:0; z-index:40;
  }
  header h1{ margin:0; font-size:20px; font-weight:800; letter-spacing:.2px }
  header .actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  .container{
    max-width:1200px; margin:18px auto; padding:0 16px 24px; display:grid; gap:16px;
    grid-template-columns: 360px 1fr;
  }
  .panel{
    background:var(--panel); border:1px solid var(--border); border-radius:16px;
    box-shadow:var(--card-shadow);
  }
  .panel h2{
    margin:0; padding:14px 16px; font-size:16px; font-weight:700; border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between;
  }
  .panel .body{ padding:14px 16px }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
  .stack{ display:flex; flex-direction:column; gap:10px }
  .split{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
  .label{font-size:13px; color:var(--muted)}
  .badge{ display:inline-flex; gap:6px; align-items:center; background:var(--chip); color:var(--chip-ink);
    padding:6px 10px; border-radius:999px; border:1px solid color-mix(in oklab, var(--chip) 70%, #ffffff 30%) }
  .muted{ color:var(--muted) }

  /* Buttons & Inputs */
  button, select, input, textarea{
    border-radius:12px; font-size:15px; border:1px solid var(--border); background:#fff; color:var(--ink);
    padding:10px 12px;
  }
  [data-theme="dark"] button,[data-theme="dark"] select,[data-theme="dark"] input,[data-theme="dark"] textarea{
    background:#0b1326;
  }
  button{
    background:var(--brand); border:0; color:white; cursor:pointer; transition:.15s ease;
  }
  button:hover{ filter:brightness(.95) }
  button:active{ transform:translateY(1px) }
  .secondary{ background:transparent; color:var(--ink) }
  .ghost{ border:1px dashed var(--border); background:transparent; color:var(--ink) }
  .danger{ background:var(--danger) }
  .ok{ background:var(--ok) }
  .warn{ color:var(--warn) }

  /* Camera Card */
  .camera-card .controls{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px }
  .camera-wrap{ display:flex; justify-content:center; margin:6px 0 0 0 }
  video{
    width:100%; max-width:520px; aspect-ratio:3/4; background:#000; border-radius:14px; border:2px solid var(--border);
  }
  .roi{
    position:absolute; pointer-events:none; border:2px dashed rgba(255,255,255,.7); border-radius:10px;
    width:68%; height:55%; top:50%; left:50%; transform:translate(-50%,-50%);
    box-shadow:0 0 0 200vmax rgba(0,0,0,.16) inset;
  }
  .video-shell{ position:relative; width:100%; display:flex; justify-content:center }
  .help{ font-size:13px; color:var(--muted); margin-top:6px }

  /* Data panels */
  textarea{ width:100%; height:200px; resize:vertical }
  table{ width:100%; border-collapse:collapse; font-size:14px }
  th,td{ border-bottom:1px solid var(--border); padding:8px 6px; text-align:left; }
  th{ position:sticky; top:0; background:var(--panel); z-index:1 }
  .stats{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px }
  .stat{
    background:var(--soft); border:1px solid var(--border); border-radius:12px; padding:12px; text-align:center
  }
  .stat .big{ font-size:22px; font-weight:800 }
  .hint{ font-size:13px; color:var(--muted) }

  /* Toasts */
  .toast{ position:fixed; right:16px; top:16px; z-index:9999; display:flex; flex-direction:column; gap:8px }
  .toast .item{
    background:var(--ok); color:#fff; padding:10px 12px; border-radius:12px; box-shadow:var(--card-shadow);
    transform:translateY(-8px); opacity:0; animation:toastIn .16s ease-out forwards;
  }
  @keyframes toastIn{ to{ transform:translateY(0); opacity:1 } }

  /* Modal */
  dialog{
    width:min(700px,92vw); border:1px solid var(--border); border-radius:16px; padding:0; background:var(--panel);
    color:var(--ink); box-shadow:var(--card-shadow);
  }
  dialog::backdrop{ background:rgba(0,0,0,.4) }
  .modal-head{ padding:14px 16px; border-bottom:1px solid var(--border); font-weight:700 }
  .modal-body{ padding:14px 16px; }
  .modal-foot{ padding:12px 16px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:8px }
  .kbd{
    display:inline-block; padding:2px 6px; border-radius:6px; border:1px solid var(--border); background:var(--soft); font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px;
  }

  /* Responsive */
  @media (max-width:980px){
    .container{ grid-template-columns:1fr }
    .stats{ grid-template-columns:repeat(2,1fr) }
  }
</style>
</head>
<body>
  <header>
    <h1>üì∏ Barcode Scanner ‚Äî Pro</h1>
    <div class="actions">
      <button id="btnHelp" class="secondary">‚ùì Help</button>
      <button id="btnTheme" class="secondary">üåô Dark</button>
      <span class="badge" id="statusBadge">‚è∏Ô∏è Camera uit</span>
    </div>
  </header>

  <div class="container">
    <!-- LEFT: CAMERA & SETTINGS -->
    <section class="panel camera-card">
      <h2>
        Camera & Bediening
        <span class="badge" id="badgeEnv">HTTPS vereist</span>
      </h2>
      <div class="body stack">
        <div class="controls">
          <button id="startStopBtn">üé• Start camera</button>
          <button id="refocusBtn" class="secondary" disabled>üîÅ Refocus</button>
          <button id="torchBtn" class="secondary" style="display:none">üî¶ Zaklamp</button>
          <button id="undoBtn" class="secondary" disabled>‚Ü©Ô∏è Undo</button>
          <button id="clearBtn" class="ghost">üßπ Wis alles</button>
        </div>

        <div class="split">
          <div class="stack">
            <label class="label">Camera</label>
            <select id="cameraSelect" disabled></select>
          </div>
          <div class="stack">
            <label class="label">Resolutie (voorkeur)</label>
            <select id="resolutionSelect">
              <option value="hd">HD 1280√ó720</option>
              <option value="fhd" selected>Full HD 1920√ó1080</option>
              <option value="qhd">QHD 2560√ó1440</option>
              <option value="uhd">UHD 3840√ó2160</option>
            </select>
          </div>
        </div>

        <div class="video-shell">
          <div class="camera-wrap">
            <video id="preview" autoplay playsinline muted></video>
          </div>
          <div class="roi" id="roi"></div>
        </div>
        <div class="help" id="secureNote" style="display:none;">
          ‚ö†Ô∏è Open via <b>https</b> (GitHub Pages is goed) en sta <b>camera</b> toe in iOS instellingen.
        </div>

        <div class="panel body" style="border:1px dashed var(--border); border-radius:12px;">
          <div class="row">
            <div class="stack" style="min-width:220px">
              <label class="label">Debounce (ms) ‚Äî filter dubbele frames</label>
              <input id="debounce" type="range" min="0" max="1500" step="50" value="500"/>
              <div class="hint"><span id="debounceVal">500</span> ms</div>
            </div>
            <div class="stack" style="min-width:220px">
              <label class="label">Instellingen</label>
              <div class="row">
                <label><input type="checkbox" id="optSound" checked/> Geluid</label>
                <label><input type="checkbox" id="optNoDupes"/> Geen duplicaten</label>
                <label><input type="checkbox" id="optAutoscroll" checked/> Auto-scroll</label>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- RIGHT: DATA / STATS -->
    <section class="panel">
      <h2>Scans & Export <span id="sessionBadge" class="badge">Sessie actief</span></h2>
      <div class="body stack">
        <div class="stats">
          <div class="stat"><div class="label">Totaal</div><div class="big" id="statTotal">0</div></div>
          <div class="stat"><div class="label">Uniek</div><div class="big" id="statUnique">0</div></div>
          <div class="stat"><div class="label">Laatste</div><div class="big" id="statLast">‚Äî</div></div>
          <div class="stat"><div class="label">Looptijd</div><div class="big" id="statTime">00:00</div></div>
        </div>

        <div class="row">
          <button id="copyTxt" class="secondary">üìã Kopieer (TXT)</button>
          <button id="downloadTxt" class="secondary">‚¨áÔ∏è Download TXT</button>
          <button id="downloadCsv" class="secondary">‚¨áÔ∏è Download CSV</button>
          <button id="downloadJson" class="secondary">‚¨áÔ∏è Download JSON</button>
          <label for="importFile" class="secondary" style="cursor:pointer;">‚¨ÜÔ∏è Import</label>
          <input id="importFile" type="file" accept=".txt,.csv,.json" style="display:none" />
        </div>

        <div class="stack">
          <label class="label">Ruwe lijst (copy/paste)</label>
          <textarea id="output" readonly placeholder="Elke scan komt op een nieuwe regel‚Ä¶"></textarea>
          <div class="hint">Tip: je kunt alles hier in √©√©n keer kopi√´ren en plakken in Word/Excel.</div>
        </div>

        <div class="stack">
          <label class="label">Tabel (met tijd & type)</label>
          <div style="max-height:260px; overflow:auto; border:1px solid var(--border); border-radius:12px;">
            <table id="grid">
              <thead><tr><th>#</th><th>Barcode</th><th>Type</th><th>Tijd</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

      </div>
    </section>
  </div>

  <!-- TOASTS -->
  <div class="toast" id="toast"></div>

  <!-- HELP MODAL -->
  <dialog id="dlgHelp">
    <div class="modal-head">Help & Sneltoetsen</div>
    <div class="modal-body stack">
      <div><b>iPhone camera werkt niet?</b>
        <ul>
          <li>Open de site via <b>HTTPS</b> (GitHub Pages is prima).</li>
          <li>Sta camera toe: <i>Instellingen ‚Üí Safari/Chrome ‚Üí Camera ‚Üí Toestaan</i>.</li>
          <li>Zet stille modus uit als je de <b>piep</b> wilt horen.</li>
        </ul>
      </div>
      <div><b>Sneltoetsen</b>
        <ul>
          <li><span class="kbd">S</span> Start/Stop camera</li>
          <li><span class="kbd">R</span> Refocus</li>
          <li><span class="kbd">T</span> Zaklamp aan/uit (indien ondersteund)</li>
          <li><span class="kbd">U</span> Undo laatste scan</li>
          <li><span class="kbd">C</span> Kopieer TXT</li>
          <li><span class="kbd">D</span> Wis alles</li>
        </ul>
      </div>
      <div class="hint">Data wordt lokaal opgeslagen (LocalStorage) en hersteld bij het openen.</div>
    </div>
    <div class="modal-foot">
      <button id="btnHelpClose" class="secondary">Sluiten</button>
    </div>
  </dialog>

<script>
/* =========================
   ENVIRONMENT & ZXING
   ========================= */
const isSecure = location.protocol === 'https:' || ['localhost','127.0.0.1'].includes(location.hostname);
const $ = (q)=>document.querySelector(q);
const $$ = (q)=>document.querySelectorAll(q);

const statusBadge = $('#statusBadge');
const secureNote = $('#secureNote');
const badgeEnv = $('#badgeEnv');
secureNote.style.display = isSecure ? 'none' : 'block';
badgeEnv.textContent = isSecure ? 'HTTPS ‚úî' : 'HTTPS vereist';

const formats = [
  ZXing.BarcodeFormat.QR_CODE, ZXing.BarcodeFormat.CODE_128, ZXing.BarcodeFormat.CODE_39,
  ZXing.BarcodeFormat.CODE_93, ZXing.BarcodeFormat.EAN_13, ZXing.BarcodeFormat.EAN_8,
  ZXing.BarcodeFormat.UPC_A, ZXing.BarcodeFormat.UPC_E, ZXing.BarcodeFormat.ITF,
  ZXing.BarcodeFormat.CODABAR, ZXing.BarcodeFormat.DATA_MATRIX, ZXing.BarcodeFormat.AZTEC,
  ZXing.BarcodeFormat.PDF_417
];
const hints = new Map();
hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
const reader = new ZXing.BrowserMultiFormatReader(hints);

/* =========================
   UI ELEMENTS
   ========================= */
const videoEl = $('#preview');
const roiEl = $('#roi');
const startStopBtn = $('#startStopBtn');
const refocusBtn = $('#refocusBtn');
const torchBtn = $('#torchBtn');
const cameraSelect = $('#cameraSelect');
const resSelect = $('#resolutionSelect');
const outputEl = $('#output');
const undoBtn = $('#undoBtn');
const clearBtn = $('#clearBtn');
const copyTxtBtn = $('#copyTxt');
const downloadTxtBtn = $('#downloadTxt');
const downloadCsvBtn = $('#downloadCsv');
const downloadJsonBtn = $('#downloadJson');
const importFile = $('#importFile');
const toast = $('#toast');
const btnHelp = $('#btnHelp');
const dlgHelp = $('#dlgHelp');
const btnHelpClose = $('#btnHelpClose');
const btnTheme = $('#btnTheme');

const statTotal = $('#statTotal');
const statUnique = $('#statUnique');
const statLast = $('#statLast');
const statTime = $('#statTime');
const sessionBadge = $('#sessionBadge');

const debounceRange = $('#debounce');
const debounceVal = $('#debounceVal');
const optSound = $('#optSound');
const optNoDupes = $('#optNoDupes');
const optAutoscroll = $('#optAutoscroll');

const gridBody = $('#grid tbody');

/* =========================
   STATE
   ========================= */
let scanning = false;
let currentDeviceId = null;
let activeTrack = null;
let torchOn = false;

let audioCtx = null, canBeep = false;

let scans = []; // {code, format, ts}
let lastAdded = { text:'', ts:0 };
let startTs = null;

let settings = {
  debounce: 500,
  sound: true,
  noDupes: false,
  autoscroll: true,
  theme: (localStorage.getItem('barcode.theme') || 'light')
};

/* =========================
   THEME
   ========================= */
function applyTheme(){
  document.documentElement.setAttribute('data-theme', settings.theme);
  btnTheme.textContent = settings.theme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
}
applyTheme();

/* =========================
   AUDIO (BEEP)
   ========================= */
function initAudio(){
  try{
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    canBeep = true;
  }catch(e){ canBeep = false; }
}
function beep(){
  if (!settings.sound || !canBeep || !audioCtx) return;
  const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
  osc.type = 'square';
  osc.frequency.setValueAtTime(1250, audioCtx.currentTime);
  gain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.35, audioCtx.currentTime + 0.01);
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime + 0.08);
}

/* =========================
   TOAST / NOTIFY
   ========================= */
function notifyOK(msg){
  const el = document.createElement('div');
  el.className = 'item';
  el.textContent = msg;
  toast.appendChild(el);
  setTimeout(() => {
    el.style.transition = 'opacity .2s ease, transform .2s ease';
    el.style.opacity = '0'; el.style.transform = 'translateY(-8px)';
    setTimeout(() => toast.removeChild(el), 220);
  }, 1400);
}

/* =========================
   HELPERS
   ========================= */
function setStatus(text, emoji='‚ÑπÔ∏è'){ statusBadge.textContent = `${emoji} ${text}`; }
function stopTracks(stream){ if (stream) stream.getTracks().forEach(t=>t.stop()); }
function fmtTime(ts){
  const d = new Date(ts);
  return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}
function dl(filename, text){
  const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
  URL.revokeObjectURL(a.href);
}

/* =========================
   CAMERA PICK & RESOLUTION
   ========================= */
async function populateCameras(preferBack = true){
  try{
    const tmp = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal:'environment' } }, audio:false });
    stopTracks(tmp);
  }catch(_){}

  const devices = await navigator.mediaDevices.enumerateDevices();
  const videoInputs = devices.filter(d => d.kind === 'videoinput');

  cameraSelect.innerHTML = '';
  videoInputs.forEach((d, idx) => {
    const opt = document.createElement('option');
    opt.value = d.deviceId;
    opt.textContent = d.label || `Camera ${idx+1}`;
    cameraSelect.appendChild(opt);
  });

  let preferredId = videoInputs.length ? videoInputs[0].deviceId : null;
  if (preferBack && videoInputs.length){
    const backRegex = /(back|rear|environment|tele|wide|achter)/i;
    const back = videoInputs.find(d => backRegex.test(d.label));
    preferredId = back ? back.deviceId : videoInputs[videoInputs.length-1].deviceId;
  }
  currentDeviceId = preferredId;
  if (preferredId) cameraSelect.value = preferredId;
  cameraSelect.disabled = videoInputs.length <= 1;
}

function resPreset(){
  switch(resSelect.value){
    case 'hd': return { width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:30} };
    case 'fhd': return { width:{ideal:1920}, height:{ideal:1080}, frameRate:{ideal:30} };
    case 'qhd': return { width:{ideal:2560}, height:{ideal:1440}, frameRate:{ideal:30} };
    case 'uhd': return { width:{ideal:3840}, height:{ideal:2160}, frameRate:{ideal:30} };
  }
}

/* =========================
   FOCUS / QUALITY
   ========================= */
async function applyQualityAndFocus(track){
  if (!track) return;
  try{
    const caps = track.getCapabilities ? track.getCapabilities() : {};
    const advanced = [];
    if (caps.focusMode && caps.focusMode.length) advanced.push({ focusMode:'continuous' });
    if (caps.exposureMode && caps.exposureMode.length) advanced.push({ exposureMode:'continuous' });
    if (caps.whiteBalanceMode && caps.whiteBalanceMode.length) advanced.push({ whiteBalanceMode:'continuous' });

    // Close-focus if available
    if (caps.focusDistance && typeof caps.focusDistance.min === 'number'){
      advanced.push({ focusDistance: caps.focusDistance.min });
    }
    // Slight zoom to help small barcodes
    if (caps.zoom && typeof caps.zoom.max === 'number'){
      const mid = Math.min(caps.zoom.max, Math.max(caps.zoom.min || 1, (caps.zoom.max*0.35)));
      advanced.push({ zoom: mid });
    }
    const base = Object.assign({}, resPreset());
    await track.applyConstraints(Object.assign(base, advanced.length ? { advanced } : {}));

    if (caps.torch){ torchBtn.style.display = ''; torchBtn.disabled = false; }
    else { torchBtn.style.display = 'none'; }
    refocusBtn.disabled = false;
  }catch(_){
    refocusBtn.disabled = false;
  }
}

/* =========================
   START / STOP SCANNING
   ========================= */
async function startScanning(){
  if (!isSecure){
    setStatus('Open via https', 'üîí'); alert('Open via https (GitHub Pages is goed).');
    return;
  }
  try{
    scanning = true; initAudio();
    startStopBtn.textContent = '‚èπÔ∏è Stop camera';
    setStatus('Camera aan', 'üü¢');
    sessionBadge.textContent = 'Sessie actief';

    await populateCameras(true);

    const constraints = {
      audio:false,
      video:Object.assign({
        deviceId: currentDeviceId ? { exact: currentDeviceId } : undefined,
        facingMode:{ ideal:'environment' }
      }, resPreset(), { advanced:[ { focusMode:'continuous' }, { exposureMode:'continuous' }, { whiteBalanceMode:'continuous' } ] })
    };

    await reader.decodeFromConstraints(constraints, videoEl, (result, err) => {
      if (result){
        const code = result.getText();
        const fmt = result.getBarcodeFormat ? String(result.getBarcodeFormat()) : '‚Äî';
        const now = Date.now();

        // Debounce
        if (settings.noDupes && scans.some(s => s.code===code)) return;
        if (!lastAdded.ts) lastAdded.ts = 0;
        if (code === lastAdded.text && (now - lastAdded.ts) < settings.debounce) return;

        // Commit scan
        const rec = {code, format:fmt, ts:now};
        scans.push(rec);
        lastAdded = {text:code, ts:now};
        if (outputEl.value) outputEl.value += '\n' + code; else outputEl.value = code;
        addRow(rec);
        updateStats();
        persist();

        if (settings.autoscroll){ outputEl.scrollTop = outputEl.scrollHeight; document.querySelector('#grid').parentElement.scrollTop = 999999; }

        beep();
        notifyOK(`Barcode ${code} gescand`);
        statLast.textContent = code;
      }
    });

    const stream = videoEl.srcObject;
    activeTrack = stream && stream.getVideoTracks ? stream.getVideoTracks()[0] : null;
    await applyQualityAndFocus(activeTrack);

    // Tap-to-refocus
    videoEl.addEventListener('click', refocus);

    undoBtn.disabled = scans.length === 0;
    if (!startTs) { startTs = Date.now(); tickUptime(); }

  }catch(e){
    console.error(e);
    scanning = false;
    startStopBtn.textContent = 'üé• Start camera';
    setStatus('Kon camera niet starten', 'üî¥');
    alert('Camera start niet. Controleer HTTPS + camera-toestemming.');
  }
}
function stopScanning(){
  scanning = false;
  startStopBtn.textContent = 'üé• Start camera';
  setStatus('Camera uit', '‚è∏Ô∏è');
  try { reader.reset(); } catch(_){}
  if (videoEl.srcObject) stopTracks(videoEl.srcObject);
  videoEl.srcObject = null;
  activeTrack = null; torchOn = false;
  videoEl.removeEventListener('click', refocus);
}

/* =========================
   GRID / STATS / STORAGE
   ========================= */
function addRow({code, format, ts}){
  const idx = scans.length;
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${idx}</td><td>${escapeHtml(code)}</td><td>${escapeHtml(format)}</td><td>${fmtTime(ts)}</td>`;
  gridBody.appendChild(tr);
}
function rebuildGrid(){
  gridBody.innerHTML = '';
  scans.forEach(addRow);
}
function updateStats(){
  statTotal.textContent = String(scans.length);
  statUnique.textContent = String(new Set(scans.map(s=>s.code)).size);
  statLast.textContent = scans.length ? scans[scans.length-1].code : '‚Äî';
}
function persist(){
  const data = { scans, settings, startTs };
  localStorage.setItem('barcode.data', JSON.stringify(data));
}
function restore(){
  const raw = localStorage.getItem('barcode.data');
  if (!raw) return;
  try{
    const data = JSON.parse(raw);
    scans = data.scans || [];
    settings = Object.assign(settings, data.settings||{});
    startTs = data.startTs || null;

    // apply settings UI
    debounceRange.value = settings.debounce;
    debounceVal.textContent = settings.debounce;
    optSound.checked = settings.sound;
    optNoDupes.checked = settings.noDupes;
    optAutoscroll.checked = settings.autoscroll;
    document.documentElement.setAttribute('data-theme', settings.theme);
    btnTheme.textContent = settings.theme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';

    // build views
    outputEl.value = scans.map(s=>s.code).join('\n');
    rebuildGrid();
    updateStats();
    undoBtn.disabled = scans.length === 0;
    if (startTs) tickUptime();
  }catch(_){}
}
function clearAll(){
  scans = [];
  outputEl.value = '';
  gridBody.innerHTML = '';
  updateStats();
  persist();
  undoBtn.disabled = true;
  statLast.textContent = '‚Äî';
}
function undo(){
  const rec = scans.pop();
  if (!rec) return;
  // remove last line from textarea
  const lines = outputEl.value.split('\n'); lines.pop(); outputEl.value = lines.join('\n');
  // remove grid last row
  if (gridBody.lastChild) gridBody.removeChild(gridBody.lastChild);
  updateStats(); persist();
  undoBtn.disabled = scans.length === 0;
}
function tickUptime(){
  if (!startTs) return;
  const d = Date.now() - startTs;
  const s = Math.floor(d/1000);
  const mm = String(Math.floor(s/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  statTime.textContent = `${mm}:${ss}`;
  requestAnimationFrame(tickUptime);
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

/* =========================
   TORCH & REFOCUS
   ========================= */
async function toggleTorch(){
  if (!activeTrack) return;
  try{
    const caps = activeTrack.getCapabilities ? activeTrack.getCapabilities() : {};
    if (!caps.torch) return;
    torchOn = !torchOn;
    await activeTrack.applyConstraints({ advanced:[{ torch: torchOn }] });
    torchBtn.textContent = torchOn ? 'üî¶ Zaklamp uit' : 'üî¶ Zaklamp aan';
  }catch(_){}
}
async function refocus(){
  if (!activeTrack) return;
  await applyQualityAndFocus(activeTrack);
  if (settings.sound) beep();
  notifyOK('Scherpstelling bijgewerkt');
}

/* =========================
   IMPORT / EXPORT
   ========================= */
async function copyTxt(){
  try{ await navigator.clipboard.writeText(outputEl.value); setStatus('Gekopieerd', 'üìã'); }
  catch{ outputEl.select(); document.execCommand('copy'); setStatus('Gekopieerd (fallback)', 'üìã'); }
}
function toCSV(){
  const rows = [['index','barcode','type','time']].concat(scans.map((s,i)=>[i,s.code,s.format,fmtTime(s.ts)]));
  return rows.map(r=>r.map(x=>/[,\"\n]/.test(String(x))?`"${String(x).replace(/"/g,'""')}"`:x).join(',')).join('\n');
}
function toJSON(){ return JSON.stringify(scans, null, 2); }

function importData(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const text = reader.result;
      if (file.name.endsWith('.json')){
        const arr = JSON.parse(text);
        if (!Array.isArray(arr)) throw new Error('Invalid JSON');
        arr.forEach(o => {
          const rec = { code:String(o.code||o), format:String(o.format||'‚Äî'), ts: Number(o.ts||Date.now()) };
          scans.push(rec);
        });
      }else if (file.name.endsWith('.csv')){
        const lines = text.split(/\r?\n/).filter(Boolean);
        const hdr = lines.shift();
        lines.forEach((ln,i)=>{
          const cols = ln.split(','); // naive parse OK for simple data
          const code = (cols[1]||'').replace(/^"|"$/g,'').replace(/""/g,'"');
          const fmt  = (cols[2]||'‚Äî').replace(/^"|"$/g,'').replace(/""/g,'"');
          const time = Date.now(); // keep now
          scans.push({code, format:fmt, ts:time});
        });
      }else{
        // txt: one per line
        text.split(/\r?\n/).forEach(line=>{
          const v = line.trim(); if (!v) return;
          scans.push({code:v, format:'‚Äî', ts:Date.now()});
        });
      }
      outputEl.value = scans.map(s=>s.code).join('\n');
      rebuildGrid(); updateStats(); persist();
      undoBtn.disabled = scans.length === 0;
      notifyOK('Import gereed');
    }catch(e){ alert('Import mislukt: ' + e.message); }
  };
  reader.readAsText(file);
}

/* =========================
   EVENTS
   ========================= */
startStopBtn.addEventListener('click', () => { if (!scanning) startScanning(); else stopScanning(); });
refocusBtn.addEventListener('click', refocus);
torchBtn.addEventListener('click', toggleTorch);
cameraSelect.addEventListener('change', e => { currentDeviceId = e.target.value; if (scanning){ stopScanning(); startScanning(); } });
resSelect.addEventListener('change', () => { if (scanning){ stopScanning(); startScanning(); } });

undoBtn.addEventListener('click', undo);
clearBtn.addEventListener('click', () => { if (confirm('Alles wissen?')) clearAll(); });

copyTxtBtn.addEventListener('click', copyTxt);
downloadTxtBtn.addEventListener('click', () => dl('barcodes.txt', outputEl.value));
downloadCsvBtn.addEventListener('click', () => dl('barcodes.csv', toCSV()));
downloadJsonBtn.addEventListener('click', () => dl('barcodes.json', toJSON()));
importFile.addEventListener('change', e => { const f = e.target.files?.[0]; if (f) importData(f); e.target.value=''; });

debounceRange.addEventListener('input', e => { settings.debounce = Number(e.target.value); debounceVal.textContent = settings.debounce; persist(); });
optSound.addEventListener('change', e => { settings.sound = e.target.checked; persist(); });
optNoDupes.addEventListener('change', e => { settings.noDupes = e.target.checked; persist(); });
optAutoscroll.addEventListener('change', e => { settings.autoscroll = e.target.checked; persist(); });

btnHelp.addEventListener('click', () => dlgHelp.showModal());
btnHelpClose.addEventListener('click', () => dlgHelp.close());
btnTheme.addEventListener('click', () => {
  settings.theme = settings.theme === 'dark' ? 'light' : 'dark';
  localStorage.setItem('barcode.theme', settings.theme);
  applyTheme();
});

/* Keyboard shortcuts */
document.addEventListener('keydown', (e) => {
  if (e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
  const k = e.key.toLowerCase();
  if (k==='s'){ startStopBtn.click(); }
  else if (k==='r'){ refocusBtn.click(); }
  else if (k==='t'){ torchBtn.click(); }
  else if (k==='u'){ undoBtn.click(); }
  else if (k==='c'){ copyTxtBtn.click(); }
  else if (k==='d'){ clearBtn.click(); }
});

/* UPTIME TICK */
function startTimerIfNeeded(){ if (!startTs){ startTs = Date.now(); tickUptime(); persist(); }}

/* Restore data on load */
restore();

/* Start hint */
if (!isSecure){ secureNote.style.display='block'; }

/* Start session timer if we already had scans */
if (scans.length && !startTs){ startTimerIfNeeded(); }

/* Accessibility: ROI hint on hover */
roiEl.title = 'Richt de barcode binnen dit kader voor de beste herkenning';
</script>
</body>
</html>
